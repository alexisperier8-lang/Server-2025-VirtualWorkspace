name: Windows Server 2025 Workspace (CMD + PowerShell Loop)

on:
  workflow_dispatch:
    inputs:
      TELEGRAM_BOT_TOKEN:
        description: 'Telegram Bot Token'
        required: true
      TELEGRAM_CHAT_ID:
        description: 'Telegram Chat ID'
        required: true

jobs:
  setup-workspace:
    runs-on: windows-2025
    timeout-minutes: 360

    steps:
      - name: üöÄ Telegram ‚Äî Setup Started
        shell: powershell
        run: |
          $token = "${{ github.event.inputs.TELEGRAM_BOT_TOKEN }}"
          $chatId = "${{ github.event.inputs.TELEGRAM_CHAT_ID }}"
          $msg = "üöÄ *Cloud PC Initialization Started*`n`nüñ•Ô∏è Windows Version: *Windows Server 2025*`n‚è≥ Please wait while the environment is being prepared."
          Invoke-RestMethod -Uri "https://api.telegram.org/bot$token/sendMessage" -Method POST -Body @{
            chat_id=$chatId
            text=$msg
            parse_mode="Markdown"
          }

      - name: üßë Create User and Configure Groups
        shell: cmd
        run: |
          echo Initializing Windows Server 2025 Workspace...
          net user User act1-1234 /add
          net localgroup Administrators User /add
          net localgroup "Remote Desktop Users" User /add

      - name: üåê Install and Configure Tailscale
        shell: cmd
        run: |
          powershell -Command "Invoke-WebRequest -Uri 'https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe' -OutFile '%USERPROFILE%\tailscale-setup.exe'"
          "%USERPROFILE%\tailscale-setup.exe" /quiet
          powershell -Command "Start-Sleep -Seconds 20"

          if exist "%ProgramFiles%\Tailscale\tailscale.exe" (
              set "TAILSCALE_PATH=%ProgramFiles%\Tailscale\tailscale.exe"
          ) else if exist "%ProgramFiles(x86)%\Tailscale\tailscale.exe" (
              set "TAILSCALE_PATH=%ProgramFiles(x86)%\Tailscale\tailscale.exe"
          ) else (
              exit /b 1
          )

          "%TAILSCALE_PATH%" up --hostname=windows2025-workspace

      - name: üîê Telegram ‚Äî Tailscale Authorization Required
        shell: powershell
        run: |
          $token = "${{ github.event.inputs.TELEGRAM_BOT_TOKEN }}"
          $chatId = "${{ github.event.inputs.TELEGRAM_CHAT_ID }}"
          $msg = "üîê *Action Required*`n`nTailscale authorization is needed to complete setup.`nPlease approve the device in your Tailscale admin panel."
          Invoke-RestMethod -Uri "https://api.telegram.org/bot$token/sendMessage" -Method POST -Body @{
            chat_id=$chatId
            text=$msg
            parse_mode="Markdown"
          }

      - name: üì° Get Tailscale IP
        shell: powershell
        run: |
          $ip = & "$Env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      - name: ‚úÖ Telegram ‚Äî Workspace Ready
        shell: powershell
        run: |
          $token = "${{ github.event.inputs.TELEGRAM_BOT_TOKEN }}"
          $chatId = "${{ github.event.inputs.TELEGRAM_CHAT_ID }}"
          $ip = "${{ env.TAILSCALE_IP }}"

          $msg = "‚úÖ *Cloud PC Ready*`n`nüñ•Ô∏è *Windows Server 2025*`nüåê *Tailscale IP:* `$ip``nüßë User: `User``nüîë Password: `act1-1234``n`nYou can now connect via RDP.`nüì© @daniel63if"

          Invoke-RestMethod -Uri "https://api.telegram.org/bot$token/sendMessage" -Method POST -Body @{
            chat_id=$chatId
            text=$msg
            parse_mode="Markdown"
          }

      - name: ‚è≥ Keep Workspace Alive (Minsk Time)
        shell: powershell
        run: |
          $tz = [System.TimeZoneInfo]::FindSystemTimeZoneById('FLE Standard Time')
          $endTime = [System.TimeZoneInfo]::ConvertTimeBySystemTimeZoneId((Get-Date).AddHours(6), $tz.Id)
          Write-Host "Workspace active until (Minsk time): $endTime"

          while ($true) {
              Start-Sleep -Seconds 10
          }
